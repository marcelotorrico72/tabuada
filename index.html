<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabuada Fácil!</title>
    <!-- Carrega o Tailwind CSS para um design moderno e responsivo --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fonte personalizada para um visual mais amigável */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Efeito de transição suave */
        .feedback-anim {
            transition: opacity 0.3s ease-in-out;
        }
        /* Garante que o modal de nome esteja no topo */
        #name-modal-overlay {
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen flex items-center justify-center p-4">

    <!-- Modal para Pedir o Nome (Inicialmente escondido) -->
    <div id="name-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Qual é o seu nome?</h2>
            <input type="text" id="name-input" class="w-full text-2xl p-3 border-4 border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-300 outline-none text-center" placeholder="Digite seu nome...">
            <button id="save-name-btn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl py-3 px-6 rounded-lg transition duration-200 shadow-lg">
                Salvar e Começar
            </button>
        </div>
    </div>

    <!-- Container Principal do Jogo --><div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-6 sm:p-10 text-center">

        <!-- Título -->
        <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2">
            Tabuada Fácil!
        </h1>
        
        <!-- Saudação (inicialmente escondida) -->
        <h2 id="welcome-greeting" class="hidden text-2xl font-semibold text-gray-600 mb-6"></h2>

        <!-- Seletor de Tabuada --><div id="table-selector" class="mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Escolha uma tabuada para praticar:</h2>
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                <!-- Botões para cada tabuada (1-10) --><button data-table="1" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">1</button>
                <button data-table="2" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">2</button>
                <button data-table="3" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">3</button>
                <button data-table="4" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">4</button>
                <button data-table="5" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">5</button>
                <button data-table="6" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">6</button>
                <button data-table="7" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">7</button>
                <button data-table="8" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">8</button>
                <button data-table="9" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">9</button>
                <button data-table="10" class="table-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">10</button>
                <!-- Botão de Desafio Misto --><button data-table="mixed" class="table-btn col-span-3 sm:col-span-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-md">
                    Desafio Misto
                </button>
            </div>
            
            <!-- Histórico de Resultados (inicialmente escondido) -->
            <div id="history-area" class="mt-10 text-left hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-3 text-center">Últimos Resultados:</h3>
                <ul id="history-list" class="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto shadow-inner space-y-2">
                    <!-- Resultados serão injetados aqui pelo JS -->
                </ul>
            </div>
        </div>

        <!-- Área do Jogo (inicialmente escondida) --><div id="game-area" class="hidden">
            
            <!-- Pontuação e Título da Tabuada --><div class="flex justify-between items-center mb-6">
                <h2 id="current-table-title" class="text-2xl font-bold text-indigo-600"></h2>
                <div id="score" class="text-lg font-bold text-green-600">Pontos: 0</div>
                <div id="question-counter" class="text-lg font-bold text-gray-500">Pergunta: 0 / 20</div>
            </div>

            <!-- Pergunta --><div id="question" class="text-5xl sm:text-7xl font-bold text-gray-800 bg-gray-100 p-8 rounded-lg mb-6 shadow-inner">
                5 x 8 = ?
            </div>

            <!-- Teclado Numérico e Botão Enviar -->
            <div class="flex flex-col items-center gap-4 justify-center">
                <div id="keypad" class="grid grid-cols-3 gap-3">
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="1">1</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="2">2</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="3">3</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="4">4</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="5">5</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="6">6</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="7">7</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="8">8</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="9">9</button>
                    <button id="clear-btn" class="col-span-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center">Apagar</button>
                    <button class="keypad-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-2xl rounded-lg shadow-sm flex items-center justify-center w-20 aspect-square sm:w-24" data-digit="0">0</button>
                    <button id="submit-btn" class="col-span-3 bg-green-500 hover:bg-green-600 text-white font-bold text-2xl py-4 rounded-lg transition duration-200 shadow-lg">Enviar</button>
                </div>
            </div>

            <!-- Feedback (Correto/Incorreto) --><div id="feedback" class="feedback-anim text-2xl font-semibold mt-5 h-8">
                <!-- O feedback aparecerá aqui --></div>

            <!-- Botão para voltar --><button id="back-btn" class="mt-6 bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                Mudar Tabuada
            </button>
        </div>

        <!-- Área de Resultados (inicialmente escondida) -->
        <div id="results-area" class="hidden text-center">
            <h2 class="text-4xl font-bold text-indigo-700 mb-6">Rodada Completa!</h2>
            <div class="bg-gray-100 p-8 rounded-lg shadow-inner mb-6 space-y-4">
                <div id="final-hits" class="text-3xl font-semibold text-green-600">Acertos: 0</div>
                <div id="final-misses" class="text-3xl font-semibold text-red-600">Erros: 0</div>
            </div>
            <button id="play-again-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-2xl py-4 px-8 rounded-lg transition duration-200 shadow-lg">
                Jogar Novamente
            </button>
        </div>

    </div>

    <script>
        // --- Referências aos elementos do DOM ---
        const tableSelectorDiv = document.getElementById('table-selector');
        const gameAreaDiv = document.getElementById('game-area');
        const tableButtons = document.querySelectorAll('.table-btn');
        const currentTableTitle = document.getElementById('current-table-title');
        const scoreDisplay = document.getElementById('score');
        const questionDisplay = document.getElementById('question');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const keypadButtons = document.querySelectorAll('.keypad-btn');
        const feedbackDisplay = document.getElementById('feedback');
        const backBtn = document.getElementById('back-btn');
        
        // Novas referências para a tela de resultados
        const questionCounter = document.getElementById('question-counter');
        const resultsArea = document.getElementById('results-area');
        const finalHits = document.getElementById('final-hits');
        const finalMisses = document.getElementById('final-misses');
        const playAgainBtn = document.getElementById('play-again-btn');

        // Novas referências para o Modal de Nome e Histórico
        const nameModalOverlay = document.getElementById('name-modal-overlay');
        const nameInput = document.getElementById('name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        const welcomeGreeting = document.getElementById('welcome-greeting');
        const historyArea = document.getElementById('history-area');
        const historyList = document.getElementById('history-list');

        // --- Variáveis de Estado do Jogo ---
        let currentTable = 0; // A tabuada escolhida
        let isMixedMode = false; // Se está no modo desafio
        let num1 = 0; // Primeiro número da multiplicação
        let num2 = 0; // Segundo número da multiplicação
        let correctAnswer = 0; // Resposta correta
        let score = 0; // Pontuação (acertos)
        let misses = 0; // Contador de erros
        let questionCount = 0; // Contador de perguntas
        const TOTAL_QUESTIONS_PER_ROUND = 20;
        let feedbackTimeout; // Para esconder o feedback automaticamente
        let answerBuffer = ''; // Resposta digitada via teclado numérico
        
        let currentPlayerName = ''; // Nome do jogador
        const STORAGE_NAME_KEY = 'tabuadaFacilPlayerName';
        const STORAGE_RESULTS_KEY = 'tabuadaFacilResults';


        // --- Funções de Inicialização e Perfil ---

        /**
         * Inicializa a aplicação
         * Verifica se o nome existe no localStorage
         */
        function initializeApp() {
            currentPlayerName = localStorage.getItem(STORAGE_NAME_KEY);
            if (!currentPlayerName) {
                // Se não tem nome, mostra o modal
                nameModalOverlay.classList.remove('hidden');
                nameInput.focus();
            } else {
                // Se tem nome, saúda o jogador e carrega o histórico
                showGreeting(currentPlayerName);
                loadHistory(currentPlayerName);
            }
        }

        /**
         * Salva o nome do utilizador no localStorage
         */
        function saveName() {
            const name = nameInput.value.trim();
            if (name) {
                currentPlayerName = name;
                localStorage.setItem(STORAGE_NAME_KEY, name);
                nameModalOverlay.classList.add('hidden');
                showGreeting(name);
                loadHistory(name); // Carrega o histórico assim que o nome é salvo
            } else {
                // Opcional: Adicionar feedback de erro se o nome estiver vazio
                nameInput.classList.add('border-red-500');
                setTimeout(() => nameInput.classList.remove('border-red-500'), 1000);
            }
        }

        /**
         * Mostra a saudação de boas-vindas
         * @param {string} name - O nome do jogador
         */
        function showGreeting(name) {
            welcomeGreeting.textContent = `Olá, ${name}! Vamos praticar?`;
            welcomeGreeting.classList.remove('hidden');
        }

        /**
         * Carrega e exibe o histórico de resultados do jogador
         * @param {string} name - O nome do jogador
         */
        function loadHistory(name) {
            historyList.innerHTML = ''; // Limpa a lista antiga
            const allResults = JSON.parse(localStorage.getItem(STORAGE_RESULTS_KEY)) || [];
            
            // Filtra os resultados apenas para este jogador
            const playerResults = allResults.filter(r => r.name === name);

            if (playerResults.length === 0) {
                historyArea.classList.add('hidden'); // Esconde se não houver histórico
                return;
            }

            historyArea.classList.remove('hidden');
            
            // Mostra os últimos 5 resultados, do mais novo para o mais antigo
            playerResults.reverse().slice(0, 5).forEach(r => {
                const date = new Date(r.date).toLocaleString('pt-pt', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('li');
                li.className = 'flex flex-col sm:flex-row justify-between p-2 border-b text-sm';
                li.innerHTML = `
                    <span class="font-semibold text-indigo-600">🎲 ${r.table}</span>
                    <span class="text-gray-600">✅ ${r.hits} Acertos | ❌ ${r.misses} Erros <span class="text-gray-400 ml-2">(${date})</span></span>
                `;
                historyList.appendChild(li);
            });
        }

        // --- Funções do Jogo ---

        /**
         * Inicia o jogo para uma tabuada específica
         * @param {string} table - O número da tabuada ou 'mixed'
         */
        function startGame(table) {
            score = 0;
            misses = 0;
            questionCount = 0;
            scoreDisplay.textContent = `Pontos: ${score}`;
            isMixedMode = (table === 'mixed');

            if (isMixedMode) {
                currentTableTitle.textContent = 'Desafio Misto!';
            } else {
                currentTable = parseInt(table);
                currentTableTitle.textContent = `Tabuada do ${currentTable}`;
            }

            // Esconde o seletor e mostra a área do jogo
            tableSelectorDiv.classList.add('hidden');
            gameAreaDiv.classList.remove('hidden');
            resultsArea.classList.add('hidden'); // Garante que a tela de resultados esteja escondida

            generateQuestion();
        }

        /**
         * Gera uma nova pergunta de multiplicação
         */
        function generateQuestion() {
            questionCount++; // Incrementa o contador de perguntas
            questionCounter.textContent = `Pergunta: ${questionCount} / ${TOTAL_QUESTIONS_PER_ROUND}`;

            if (isMixedMode) {
                // Modo misto: números aleatórios de 1 a 10
                num1 = Math.floor(Math.random() * 10) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
            } else {
                // Modo de tabuada específica
                num1 = currentTable;
                num2 = Math.floor(Math.random() * 10) + 1;
            }

            correctAnswer = num1 * num2;
            answerBuffer = '';
            questionDisplay.textContent = `${num1} x ${num2} = ?`;
            updateQuestionDisplay();
        }

        /**
         * Atualiza a exibição da pergunta com a resposta digitada
         */
        function updateQuestionDisplay() {
            const shownAnswer = answerBuffer.length ? answerBuffer : '?';
            questionDisplay.textContent = `${num1} x ${num2} = ${shownAnswer}`;
        }

        /**
         * Verifica a resposta do utilizador
         */
        function checkAnswer() {
            // Limpa feedback anterior
            clearTimeout(feedbackTimeout);
            feedbackDisplay.textContent = '';
            feedbackDisplay.classList.remove('text-green-600', 'text-red-600');

            // Proteção para não submeter resposta enquanto o feedback está a ser mostrado
            if (feedbackDisplay.style.opacity == 1) return;

            const userAnswer = parseInt(answerBuffer);

            // Validação para permitir apenas números
            if (!answerBuffer || answerBuffer.trim() === '') {
                showFeedback("Por favor, digite um número.", "text-red-600");
                return;
            }
            
            if (isNaN(userAnswer)) {
                showFeedback("Ops! Digite apenas números, por favor.", "text-red-600");
                return;
            }

            if (userAnswer === correctAnswer) {
                // Resposta Correta
                score++;
                showFeedback("Correto! ✨", "text-green-600");
            } else {
                // Resposta Incorreta
                misses++;
                showFeedback(`Incorreto. A resposta era ${correctAnswer}. ❌`, "text-red-600");
            }

            scoreDisplay.textContent = `Pontos: ${score}`;

            // Verifica se a rodada terminou
            if (questionCount >= TOTAL_QUESTIONS_PER_ROUND) {
                // Rodada terminou! Mostrar resultados após o feedback
                setTimeout(showResults, 1500);
            } else {
                // Gera a próxima pergunta após um curto delay
                setTimeout(generateQuestion, 1500);
            }
        }

        /**
         * Mostra feedback ao utilizador e agenda para desaparecer
         * @param {string} message - A mensagem a mostrar
         * @param {string} colorClass - A classe de cor (Tailwind)
         */
        function showFeedback(message, colorClass) {
            feedbackDisplay.textContent = message;
            feedbackDisplay.classList.add(colorClass);
            feedbackDisplay.style.opacity = 1;

            // Agenda para esconder o feedback
            feedbackTimeout = setTimeout(() => {
                feedbackDisplay.style.opacity = 0;
            }, 1400); // Um pouco antes de gerar a nova pergunta
        }

        /**
         * Mostra a tela de resultados finais e SALVA o resultado
         */
        function showResults() {
            // --- Salvar Resultado no localStorage ---
            const result = {
                name: currentPlayerName,
                table: isMixedMode ? 'Desafio Misto' : `Tabuada do ${currentTable}`,
                hits: score,
                misses: misses,
                date: new Date().toISOString()
            };
            
            const allResults = JSON.parse(localStorage.getItem(STORAGE_RESULTS_KEY)) || [];
            allResults.push(result);
            localStorage.setItem(STORAGE_RESULTS_KEY, JSON.stringify(allResults));
            // --- Fim de Salvar Resultado ---

            gameAreaDiv.classList.add('hidden');
            resultsArea.classList.remove('hidden');
            finalHits.textContent = `Acertos: ${score}`;
            finalMisses.textContent = `Erros: ${misses}`;
        }

        /**
         * Volta para o ecrã de seleção de tabuada
         */
        function goBackToSelector() {
            gameAreaDiv.classList.add('hidden');
            resultsArea.classList.add('hidden'); // Garante que resultados estão escondidos
            tableSelectorDiv.classList.remove('hidden');
            loadHistory(currentPlayerName); // Recarrega o histórico
        }


        // --- Configuração dos Event Listeners ---

        // Listeners do Modal de Nome
        saveNameBtn.addEventListener('click', saveName);
        nameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                saveName();
            }
        });


        // Adiciona listener para cada botão de tabuada
        tableButtons.forEach(button => {
            button.addEventListener('click', () => {
                startGame(button.dataset.table);
            });
        });

        // Listeners do teclado numérico
        keypadButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const digit = btn.dataset.digit;
                // Limita a resposta a 3 dígitos por segurança (até 1000)
                if (answerBuffer.length < 3) {
                    answerBuffer += digit;
                    updateQuestionDisplay();
                }
            });
        });

        // Listener para o botão "Enviar"
        submitBtn.addEventListener('click', () => {
            checkAnswer();
        });

        // Botão para apagar a resposta digitada
        clearBtn.addEventListener('click', () => {
            answerBuffer = '';
            updateQuestionDisplay();
        });

        // Listener para o botão "Mudar Tabuada"
        backBtn.addEventListener('click', goBackToSelector);

        // Novo listener para o botão "Jogar Novamente"
        playAgainBtn.addEventListener('click', () => {
            resultsArea.classList.add('hidden');
            tableSelectorDiv.classList.remove('hidden');
            loadHistory(currentPlayerName); // Recarrega o histórico
        });

        // Removidos listeners do input; fluxo agora usa teclado numérico

        // --- Inicia a aplicação ---
        initializeApp();

    </script>
</body>
</html>